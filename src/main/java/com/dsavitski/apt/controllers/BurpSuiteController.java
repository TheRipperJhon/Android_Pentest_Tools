package com.dsavitski.apt.controllers;

import com.dsavitski.apt.service.CmdService;
import com.dsavitski.apt.service.ConfigService;
import com.dsavitski.apt.service.ToolsService;
import javafx.fxml.FXML;
import javafx.scene.control.TextField;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;

import static com.dsavitski.apt.constants.ConfigKeys.BURP_INTERFACE;
import static com.dsavitski.apt.constants.ConfigKeys.BURP_SERVER_IP;
import static com.dsavitski.apt.constants.ScriptConstants.BURPSUITE;

@Controller
public class BurpSuiteController {
    private static final Logger logger = LogManager.getLogger(BurpSuiteController.class);
    @Autowired
    private ConfigService configService;
    @Autowired
    private ToolsService toolsService;
    @Autowired
    private CmdService cmdService;

    @FXML
    private TextField textBurpInterface;
    @FXML
    private TextField textBurpServerIp;

    @FXML
    public void initialize() {
        String burpInterface = configService.getByKey(BURP_INTERFACE);
        if (textBurpInterface != null) {
            textBurpInterface.setText(burpInterface);
        }

        String localIp = configService.getByKey(BURP_SERVER_IP);
        if (localIp != null) {
            textBurpServerIp.setText(localIp);
        }
    }

    @FXML
    public void saveBurpSettings() {
        configService.saveOption(BURP_INTERFACE, textBurpInterface.getText());
        configService.saveOption(BURP_SERVER_IP, textBurpServerIp.getText());
        logger.info("Settings saved");
    }

    @FXML
    public void pullBurpCertificate() {
        toolsService.pullBurpCertificate();
    }

    @FXML
    public void launchBurpSuite() {
        logger.info("Starting Burp suite");
        cmdService.executeScript(BURPSUITE);
    }

    @FXML
    public void installBurpCert() {
        logger.info("Installing Burp suite CA to device. in case of errors try to turn off proxy");
        toolsService.installBurpCert();
    }
}
