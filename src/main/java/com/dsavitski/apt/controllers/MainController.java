package com.dsavitski.apt.controllers;

import com.dsavitski.apt.service.AdbService;
import com.dsavitski.apt.service.ConfigService;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.fxml.FXML;
import javafx.scene.control.ChoiceBox;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;

import static com.dsavitski.apt.constants.ConfigKeys.CURRENT_PACKAGE;

/**
 * Main window controller
 */

@Controller
public class MainController {
    @Autowired
    AdbService adbService;
    @FXML
    ChoiceBox<String> choicePackages;
    @Autowired
    private ConfigService configService;

    @FXML
    public void initialize() {
        flushDatabase();

        choicePackages.getSelectionModel()
                .selectedIndexProperty()
                .addListener((observable, oldValue, newValue) -> {
                    final String selectedPackage = choicePackages.getItems().get((int) newValue);
                    configService.saveOption(CURRENT_PACKAGE, selectedPackage);
                });
    }

    /**
     * Init application state - flush sensitive variables in db
     */
    private void flushDatabase() {
        configService.saveOption(CURRENT_PACKAGE, null);
    }

    @FXML
    public void pullApplicationsList() {
        ObservableList<String> packages = FXCollections.observableArrayList(adbService.pullPacketsList());
        choicePackages.setItems(packages);
        choicePackages.getSelectionModel().selectFirst();
    }


    @FXML
    public void launchAdbShell() {
        adbService.launchAdbShell();
    }

    @FXML
    public void checkFilePermissions() {
        if (!configService.isPackageSelected(true)) {
            return;
        }

        adbService.checkFilePermissions();
    }

    @FXML
    public void pullPackageFiles() {

    }

    @FXML
    public void launchMobSf() {

    }
}
