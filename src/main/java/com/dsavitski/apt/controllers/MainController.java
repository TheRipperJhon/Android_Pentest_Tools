package com.dsavitski.apt.controllers;

import com.dsavitski.apt.daemon.ConnectionDaemon;
import com.dsavitski.apt.service.CmdService;
import com.dsavitski.apt.service.ConfigService;
import com.dsavitski.apt.service.ConnectionService;
import javafx.fxml.FXML;
import javafx.scene.control.TextField;
import javafx.scene.shape.Circle;
import org.springframework.beans.factory.annotation.Autowired;

import javax.annotation.PostConstruct;

import static com.dsavitski.apt.constants.ConfigKeys.DEVICE_IP;
import static com.dsavitski.apt.constants.ScriptConstants.BURPSUITE;

/**
 * Date: 27.08.15
 * Time: 11:10
 *
 * @author Ruslan Molchanov (ruslanys@gmail.com)
 * @author http://mruslan.com
 */
@SuppressWarnings("SpringJavaAutowiringInspection")
public class MainController {

    // Инъекции Spring
    @Autowired
    private ConfigService configService;
    @Autowired
    private ConnectionService connectionService;
    @Autowired
    private CmdService cmdService;
    @Autowired
    private ConnectionDaemon connectionDaemon;

    @FXML
    private TextField textDeviceIp;
    @FXML
    private Circle shapeConnectionStatus;

    /**
     * Инициализация контроллера от JavaFX.
     * Метод вызывается после того как FXML загрузчик произвел инъекции полей.
     * <p>
     * Обратите внимание, что имя метода <b>обязательно</b> должно быть "initialize",
     * в противном случае, метод не вызовется.
     * <p>
     * Также на этом этапе еще отсутствуют бины спринга
     * и для инициализации лучше использовать метод,
     * описанный аннотацией @PostConstruct,
     * который вызовется спрингом, после того, как им будут произведены все инъекции.
     * {@link MainController#init()}
     */
    @FXML
    public void initialize() {
        // Этап инициализации JavaFX
    }

    /**
     * На этом этапе уже произведены все возможные инъекции.
     */
    @SuppressWarnings("unchecked")
    @PostConstruct
    public void init() {
        String deviceIp = configService.getByKey(DEVICE_IP);
        if (deviceIp != null) {
            textDeviceIp.setText(deviceIp);
        }

    }

    /**
     * Метод, вызываемый при нажатии на кнопку "Добавить".
     * Привязан к кнопке в FXML файле представления.
     */
    @FXML
    public void adbConnect() {
        configService.saveOption(DEVICE_IP, textDeviceIp.getText());
        connectionService.connect();
        connectionDaemon.start(shapeConnectionStatus);
    }

    public void adbDisconnect() {
        connectionService.disconnect();
        connectionDaemon.stop();
    }

    @FXML
    public void launchBurpsuite() {
        cmdService.executeScript(BURPSUITE);
    }
}
